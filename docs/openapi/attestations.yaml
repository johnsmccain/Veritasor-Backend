openapi: "3.0.0"
info:
  title: Veritasor Attestations API
  version: 1.0.0
  description: API for listing, submitting, retrieving, and revoking attestations.

paths:
  /attestations:
    get:
      summary: List attestations
      operationId: listAttestations
      tags: [attestations]
      security:
        - bearerAuth: []
      parameters:
        - name: business_id
          in: query
          required: false
          schema:
            type: string
            format: uuid
          description: Filter by business id.
          example: "7f4f44e2-1cab-486f-87ad-4f8b9f839de9"
        - name: status
          in: query
          required: false
          schema:
            $ref: "#/components/schemas/AttestationStatus"
          description: Filter by attestation status.
          example: confirmed
        - name: period
          in: query
          required: false
          schema:
            type: string
          description: Filter by attestation period (for example, YYYY-MM).
          example: "2026-01"
        - name: page
          in: query
          required: false
          schema:
            type: integer
            minimum: 1
            default: 1
        - name: limit
          in: query
          required: false
          schema:
            type: integer
            minimum: 1
            maximum: 100
            default: 20
      responses:
        "200":
          description: Paginated attestations result.
          content:
            application/json:
              schema:
                $ref: "#/components/schemas/AttestationListResponse"
              examples:
                success:
                  value:
                    data:
                      - id: "att_01JNTT3Z5XSG6D8EBMY4YFK1R4"
                        business_id: "7f4f44e2-1cab-486f-87ad-4f8b9f839de9"
                        period: "2026-01"
                        merkle_root: "8f67dce42ef706f6f4cc5af6f5b8fef04b8a1d123bc6781ef855ed4ec5f5b838"
                        tx_hash: "6a7f5c0e9a3a6057b0e7d6f15f237bb8ff79d6a8e8caccf9e4e87d91737be340"
                        status: confirmed
                        created_at: "2026-02-01T10:20:30Z"
                        updated_at: "2026-02-01T10:20:30Z"
                    meta:
                      page: 1
                      limit: 20
                      total: 1
                      totalPages: 1
        "401":
          description: Unauthorized
          content:
            application/json:
              schema:
                $ref: "#/components/schemas/Error"

    post:
      summary: Submit attestation
      operationId: submitAttestation
      tags: [attestations]
      security:
        - bearerAuth: []
      requestBody:
        required: true
        content:
          application/json:
            schema:
              $ref: "#/components/schemas/AttestationSubmitRequest"
            examples:
              submit:
                value:
                  business_id: "7f4f44e2-1cab-486f-87ad-4f8b9f839de9"
                  period: "2026-01"
                  merkle_root: "8f67dce42ef706f6f4cc5af6f5b8fef04b8a1d123bc6781ef855ed4ec5f5b838"
      responses:
        "201":
          description: Attestation created.
          content:
            application/json:
              schema:
                $ref: "#/components/schemas/Attestation"
              examples:
                created:
                  value:
                    id: "att_01JNTT3Z5XSG6D8EBMY4YFK1R4"
                    business_id: "7f4f44e2-1cab-486f-87ad-4f8b9f839de9"
                    period: "2026-01"
                    merkle_root: "8f67dce42ef706f6f4cc5af6f5b8fef04b8a1d123bc6781ef855ed4ec5f5b838"
                    tx_hash: null
                    status: submitted
                    created_at: "2026-02-01T10:20:30Z"
                    updated_at: "2026-02-01T10:20:30Z"
        "400":
          description: Invalid payload.
          content:
            application/json:
              schema:
                $ref: "#/components/schemas/Error"
        "401":
          description: Unauthorized
          content:
            application/json:
              schema:
                $ref: "#/components/schemas/Error"
        "409":
          description: Duplicate attestation for the same business and period.
          content:
            application/json:
              schema:
                $ref: "#/components/schemas/Error"

  /attestations/{id}:
    get:
      summary: Get attestation by id
      operationId: getAttestationById
      tags: [attestations]
      security:
        - bearerAuth: []
      parameters:
        - name: id
          in: path
          required: true
          schema:
            type: string
          example: "att_01JNTT3Z5XSG6D8EBMY4YFK1R4"
      responses:
        "200":
          description: Attestation details.
          content:
            application/json:
              schema:
                $ref: "#/components/schemas/Attestation"
        "401":
          description: Unauthorized
          content:
            application/json:
              schema:
                $ref: "#/components/schemas/Error"
        "404":
          description: Attestation not found.
          content:
            application/json:
              schema:
                $ref: "#/components/schemas/Error"

  /attestations/{id}/revoke:
    post:
      summary: Revoke attestation
      operationId: revokeAttestation
      tags: [attestations]
      security:
        - bearerAuth: []
      parameters:
        - name: id
          in: path
          required: true
          schema:
            type: string
          example: "att_01JNTT3Z5XSG6D8EBMY4YFK1R4"
      requestBody:
        required: false
        content:
          application/json:
            schema:
              $ref: "#/components/schemas/RevokeAttestationRequest"
            examples:
              revoke:
                value:
                  reason: "Superseded by corrected revenue data"
      responses:
        "200":
          description: Attestation revoked.
          content:
            application/json:
              schema:
                $ref: "#/components/schemas/Attestation"
              examples:
                revoked:
                  value:
                    id: "att_01JNTT3Z5XSG6D8EBMY4YFK1R4"
                    business_id: "7f4f44e2-1cab-486f-87ad-4f8b9f839de9"
                    period: "2026-01"
                    merkle_root: "8f67dce42ef706f6f4cc5af6f5b8fef04b8a1d123bc6781ef855ed4ec5f5b838"
                    tx_hash: "6a7f5c0e9a3a6057b0e7d6f15f237bb8ff79d6a8e8caccf9e4e87d91737be340"
                    status: revoked
                    created_at: "2026-02-01T10:20:30Z"
                    updated_at: "2026-02-02T08:00:00Z"
        "401":
          description: Unauthorized
          content:
            application/json:
              schema:
                $ref: "#/components/schemas/Error"
        "404":
          description: Attestation not found.
          content:
            application/json:
              schema:
                $ref: "#/components/schemas/Error"
        "409":
          description: Attestation cannot be revoked from its current state.
          content:
            application/json:
              schema:
                $ref: "#/components/schemas/Error"

components:
  securitySchemes:
    bearerAuth:
      type: http
      scheme: bearer
      bearerFormat: JWT

  schemas:
    AttestationStatus:
      type: string
      enum:
        - pending
        - submitted
        - confirmed
        - failed
        - revoked

    Attestation:
      type: object
      properties:
        id:
          type: string
          example: "att_01JNTT3Z5XSG6D8EBMY4YFK1R4"
        business_id:
          type: string
          format: uuid
          example: "7f4f44e2-1cab-486f-87ad-4f8b9f839de9"
        period:
          type: string
          example: "2026-01"
        merkle_root:
          type: string
          description: Hex-encoded Merkle root
          example: "8f67dce42ef706f6f4cc5af6f5b8fef04b8a1d123bc6781ef855ed4ec5f5b838"
        tx_hash:
          type: string
          nullable: true
          description: On-chain transaction hash, when available.
          example: "6a7f5c0e9a3a6057b0e7d6f15f237bb8ff79d6a8e8caccf9e4e87d91737be340"
        status:
          $ref: "#/components/schemas/AttestationStatus"
        created_at:
          type: string
          format: date-time
          example: "2026-02-01T10:20:30Z"
        updated_at:
          type: string
          format: date-time
          example: "2026-02-01T10:20:30Z"
      required:
        - id
        - business_id
        - period
        - merkle_root
        - status
        - created_at
        - updated_at

    AttestationSubmitRequest:
      type: object
      properties:
        business_id:
          type: string
          format: uuid
          example: "7f4f44e2-1cab-486f-87ad-4f8b9f839de9"
        period:
          type: string
          example: "2026-01"
        merkle_root:
          type: string
          description: Hex-encoded Merkle root
          example: "8f67dce42ef706f6f4cc5af6f5b8fef04b8a1d123bc6781ef855ed4ec5f5b838"
      required:
        - business_id
        - period
        - merkle_root

    RevokeAttestationRequest:
      type: object
      properties:
        reason:
          type: string
          maxLength: 500
          example: "Superseded by corrected revenue data"

    PaginationMeta:
      type: object
      properties:
        page:
          type: integer
          minimum: 1
          example: 1
        limit:
          type: integer
          minimum: 1
          maximum: 100
          example: 20
        total:
          type: integer
          minimum: 0
          example: 42
        totalPages:
          type: integer
          minimum: 0
          example: 3
      required:
        - page
        - limit
        - total
        - totalPages

    AttestationListResponse:
      type: object
      properties:
        data:
          type: array
          items:
            $ref: "#/components/schemas/Attestation"
        meta:
          $ref: "#/components/schemas/PaginationMeta"
      required:
        - data
        - meta

    Error:
      type: object
      properties:
        message:
          type: string
          example: "Validation failed"
        code:
          type: string
          example: "VALIDATION_ERROR"
      required:
        - message

tags:
  - name: attestations
    description: Attestation lifecycle operations

